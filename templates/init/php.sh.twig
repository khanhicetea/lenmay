#!/bin/bash

PHP_VER="{{ php_ver }}"

# PHP ${PHP_VER} (via PPA)
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update
sudo apt install -y php${PHP_VER}-bz2 php${PHP_VER}-cli php${PHP_VER}-common php${PHP_VER}-curl php${PHP_VER}-fpm \
    php${PHP_VER}-gd php${PHP_VER}-intl php${PHP_VER}-json php${PHP_VER}-mbstring php${PHP_VER}-mysql php${PHP_VER}-opcache \
    php${PHP_VER}-readline php${PHP_VER}-xml php${PHP_VER}-xmlrpc php${PHP_VER}-xsl php${PHP_VER}-zip
sudo sed -i "s/;date.timezone =.*/date.timezone = {{ timezone | replace("/", "\/") }}/" /etc/php/${PHP_VER}/cli/php.ini
sudo sed -i "s/;date.timezone =.*/date.timezone = {{ timezone | replace("/", "\/") }}/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/; max_input_vars =.*/max_input_vars = 10000/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/upload_max_filesize = .*/upload_max_filesize = 10M/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/post_max_size = .*/post_max_size = 12M/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/max_execution_time = .*/max_execution_time = 60/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/;opcache.enable=.*/opcache.enable=1/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/;opcache.use_cwd=.*/opcache.use_cwd=1/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/;opcache.validate_timestamps=.*/opcache.validate_timestamps=1/" /etc/php/${PHP_VER}/fpm/php.ini
sudo sed -i "s/;opcache.revalidate_freq=.*/;opcache.revalidate_freq=20/" /etc/php/${PHP_VER}/fpm/php.ini
sudo systemctl enable php${PHP_VER}-fpm.service
sudo systemctl restart php${PHP_VER}-fpm.service

sudo chown -R $USER:$USER ~/.config
curl https://getcomposer.org/installer > composer-setup.php && php composer-setup.php && sudo mv composer.phar /usr/local/bin/composer && sudo chmod +x /usr/local/bin/composer && rm composer-setup.php